<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>think-swoole基本使用 xianxin 志强网</title><meta name="keywords" content="swoole,think-swoole"><meta name="description" content="志强博客"><link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/blog.css"><link rel="stylesheet" href="/libs/layui/css/layui.css"><script src="/libs/layui/layui.js"></script><script src="/js/blog.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body class="lay-blog"><div class="header"><div class="header-wrap"><h1 class="logo pull-left"><a href="/"><img src="/img/logo.png" alt="" class="logo-img"> <img src="/img/logo-text.png" alt="" class="logo-text"></a></h1><form class="layui-form blog-seach pull-left" method="get" action="https://www.google.com/search?"><div class="layui-form-item blog-sewrap"><div class="layui-input-block blog-sebox"><i class="layui-icon layui-icon-search"></i> <input type="text" name="q" lay-verify="title" autocomplete="off" class="layui-input"> <input type="hidden" name="source" value="https://www.zhiqiang.wang"></div></div></form><div class="blog-nav pull-right"><ul class="layui-nav pull-left"><li class="layui-nav-item"><a href="/">Home</a></li><li class="layui-nav-item"><a href="/about">About</a></li><li class="layui-nav-item"><a href="/archives">Archives</a></li><li class="layui-nav-item"><a href="/tags">Tags</a></li><li class="layui-nav-item"><a href="/sitemap.xml">RSS</a></li></ul></div></div></div><div class="container-wrap"><div class="container"><div class="contar-wrap"><div class="item"><div class="item-box"><p class="layui-breadcrumb" style="visibility:inherit"><a href="/">首页 </a><a href="/categories/php/">php</a></p><h3>think-swoole基本使用</h3><h5>发布于：<span> 2020-06-04</span></h5><div class="post-meta"><a href="/tags/swoole/"><button type="button" class="layui-btn layui-btn-sm layui-bg-orange">#swoole</button> </a><a href="/tags/think-swoole/"><button type="button" class="layui-btn layui-btn-sm layui-bg-orange">#think-swoole</button></a></div><hr class="layui-border-orange"><div class="layui-content"><p class="lay-content page-content"></p><h2 id="官网文档"><a href="#官网文档" class="headerlink" title="官网文档"></a>官网文档</h2><blockquote><p>thinkphp6文档<br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp6_0/1037479">https://www.kancloud.cn/manual/thinkphp6_0/1037479</a></p><p>swoole文档<br><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/">https://wiki.swoole.com/#/</a></p><p>think-swoole文档<br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp6_0/1359700">https://www.kancloud.cn/manual/thinkphp6_0/1359700</a></p></blockquote><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require topthink/think-swoole</span><br></pre></td></tr></table></figure><h2 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think swoole [start|stop|reload|restart]</span><br></pre></td></tr></table></figure><h2 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h2><p>当你在命令行<code>php think swoole</code>下执行完成之后就会启动一个HTTP Server，可以直接访问当前的应用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x27;server&#x27;     =&gt; [</span><br><span class="line">    &#x27;host&#x27;      =&gt; env(&#x27;SWOOLE_HOST&#x27;, &#x27;0.0.0.0&#x27;), // 监听地址</span><br><span class="line">    &#x27;port&#x27;      =&gt; env(&#x27;SWOOLE_PORT&#x27;, 9501), // 监听端口</span><br><span class="line">    &#x27;mode&#x27;      =&gt; SWOOLE_PROCESS, // 运行模式 默认为SWOOLE_PROCESS</span><br><span class="line">    &#x27;sock_type&#x27; =&gt; SWOOLE_SOCK_TCP, // sock type 默认为SWOOLE_SOCK_TCP</span><br><span class="line">    &#x27;options&#x27;   =&gt; [</span><br><span class="line">    	// 服务启动后，进程ID存放文件</span><br><span class="line">        &#x27;pid_file&#x27;              =&gt; runtime_path() . &#x27;swoole.pid&#x27;,</span><br><span class="line">        // swoole 的日志文件</span><br><span class="line">        &#x27;log_file&#x27;              =&gt; runtime_path() . &#x27;swoole.log&#x27;,</span><br><span class="line">        // 守护进程模式设置 true 后台运行</span><br><span class="line">        &#x27;daemonize&#x27;             =&gt; false,</span><br><span class="line">        // 设置启动的reactor线程数</span><br><span class="line">        &#x27;reactor_num&#x27;           =&gt; swoole_cpu_num(),</span><br><span class="line">        // 设置启动的worker进程数</span><br><span class="line">        &#x27;worker_num&#x27;            =&gt; swoole_cpu_num(),</span><br><span class="line">        //配置Task进程的数量</span><br><span class="line">        &#x27;task_worker_num&#x27;       =&gt; swoole_cpu_num(),</span><br><span class="line">        //开启静态文件请求处理，需配合document_root</span><br><span class="line">        &#x27;enable_static_handler&#x27; =&gt; true,</span><br><span class="line">        //静态文件根目录</span><br><span class="line">        &#x27;document_root&#x27;         =&gt; root_path(&#x27;public&#x27;),</span><br><span class="line">        // 设置最大数据包尺寸，单位字节</span><br><span class="line">        &#x27;package_max_length&#x27;    =&gt; 20 * 1024 * 1024,</span><br><span class="line">        //配置发送输出缓冲区内存尺寸</span><br><span class="line">        &#x27;buffer_output_size&#x27;    =&gt; 10 * 1024 * 1024,</span><br><span class="line">        //设置客户端连接最大允许占用的内存数量</span><br><span class="line">        &#x27;socket_buffer_size&#x27;    =&gt; 128 * 1024 * 1024,</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><h2 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h2><p>swoole服务器运行过程中php文件是常驻内存运行，这样就可以避免重复的读取磁盘，重复的解释编译php，以便达到最高的性能，所以修改代码需要重启服务</p><p>think-swoole扩展提供热更新功能，在检测相关文件有更新会自动重启，不在需要手动完成重启，方便开发调试</p><p>生产环境下不建议开始文件监控，性能损耗，正常情况下你所修改的文件需要确认无误才能进行更新部署</p><p><code>.env</code>里面设置<code>APP_DEBUG = true</code>会默认开启热更新</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x27;hot_update&#x27; =&gt; [</span><br><span class="line">    &#x27;enable&#x27;  =&gt; env(&#x27;APP_DEBUG&#x27;, false),</span><br><span class="line">    &#x27;name&#x27;    =&gt; [&#x27;*.php&#x27;],</span><br><span class="line">    &#x27;include&#x27; =&gt; [app_path()],</span><br><span class="line">    &#x27;exclude&#x27; =&gt; [],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>参数说明</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>enable</td><td>是否开启热更新</td></tr><tr><td>name</td><td>监听哪些类型的文件变动</td></tr><tr><td>include</td><td>监听哪些目录下的文件变动</td></tr><tr><td>exclude</td><td>排除目录</td></tr></tbody></table><h2 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h2><p>先来一个官方的例子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$server = new Swoole\WebSocket\Server(&quot;0.0.0.0&quot;, 9501);</span><br><span class="line">$server-&gt;on(&#x27;open&#x27;, function (Swoole\WebSocket\Server $server, $request) &#123;</span><br><span class="line">    echo &quot;server: handshake success with fd&#123;$request-&gt;fd&#125;\n&quot;;</span><br><span class="line">&#125;);</span><br><span class="line">$server-&gt;on(&#x27;message&#x27;, function (Swoole\WebSocket\Server $server, $frame) &#123;</span><br><span class="line">    echo &quot;receive from &#123;$frame-&gt;fd&#125;:&#123;$frame-&gt;data&#125;\n&quot;;</span><br><span class="line">    $server-&gt;push($frame-&gt;fd, &quot;this is server&quot;);</span><br><span class="line">&#125;);</span><br><span class="line">$server-&gt;on(&#x27;close&#x27;, function ($ser, $fd) &#123;</span><br><span class="line">    echo &quot;client &#123;$fd&#125; closed\n&quot;;</span><br><span class="line">&#125;);</span><br><span class="line">$server-&gt;start();</span><br></pre></td></tr></table></figure><p>开启think-swoole的websocket功能 <code>\config\swoole.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;websocket&#x27;  =&gt; [</span><br><span class="line">	&#x27;enable&#x27;        =&gt; true,</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>创建三个事件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwWsConnect</span><br><span class="line">php think make:listener SwWsClose</span><br><span class="line">php think make:listener SwWsMessage</span><br></pre></td></tr></table></figure><p>然后将这三个事件写到到事件监听中，分别有以下2中文件可以修改方式，注意二选一</p><p>thinkphp6自带的事件绑定<code>app\event.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  &#x27;listen&#x27;    =&gt; [</span><br><span class="line">........</span><br><span class="line">      // 监听链接</span><br><span class="line">      &#x27;swoole.websocket.Connect&#x27; =&gt; [</span><br><span class="line">          \app\listener\SwWsConnect::class</span><br><span class="line">      ],</span><br><span class="line">      //关闭连接</span><br><span class="line">      &#x27;swoole.websocket.Close&#x27; =&gt; [</span><br><span class="line">          \app\listener\SwWsClose::class</span><br><span class="line">      ],</span><br><span class="line">      //发送消息场景</span><br><span class="line">      &#x27;swoole.websocket.Message&#x27; =&gt; [</span><br><span class="line">          \app\listener\SwWsMessage::class</span><br><span class="line">      ]</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure><p>think-swoole事件绑定<code>config\swoole.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x27;listen&#x27;        =&gt; [</span><br><span class="line">    &#x27;connect&#x27;=&gt;\app\listener\SwWsConnect::class,</span><br><span class="line">    &#x27;close&#x27;=&gt;\app\listener\SwWsClose::class,</span><br><span class="line">    &#x27;message&#x27;=&gt; \app\listener\SwWsMessage::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure><blockquote><p>怎么选择是保存在<code>config\swoole.php</code>还是<code>app\event.php</code>配置中呢？</p><p>首先我们 我们确定一下我们这个项目中存在有几个实时通讯，</p><p>如果只是存在一个实时通讯 个人建议 保存在<code>config\swoole.php</code></p><p>如果是存在多个实时通讯，就保存在<code>app\event.php</code></p><p>key值 必须是<code>swoole.websocket.事件名称</code> 例如 <code>swoole.websocket.Message</code></p></blockquote><p>开始写事件中中方法</p><p>连接事件<code>app\listener\SwWsConnect.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public function handle($event, \think\swoole\websocket $ws)</span><br><span class="line">&#123;</span><br><span class="line">    // 获取当前发送者的fd</span><br><span class="line">    $fd = $ws-&gt;getSender();</span><br><span class="line">    echo &quot;server: handshake success with fd&#123;$fd&#125;\n&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关闭事件<code>app\listener\SwWsClose.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public function handle($event, \think\swoole\websocket $ws)</span><br><span class="line">&#123;</span><br><span class="line">    $fd = $ws-&gt;getSender();</span><br><span class="line">    echo &quot;client &#123;$fd&#125; closed\n&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>message事件<code>app\listener\SwWsMessage.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public function handle($event, \think\swoole\websocket $ws)</span><br><span class="line">&#123;</span><br><span class="line">	$fd = $ws-&gt;getSender();</span><br><span class="line">	$data = json_encode($event);</span><br><span class="line">	echo &quot;receive from &#123;$fd&#125;:&#123;$data&#125;\n&quot;;</span><br><span class="line">    $ws-&gt;emit(&quot;this is server&quot;, $fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动<code>php think swoole</code>进行测试</p><p>think-swoole中的websocket方法总结</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//给自己发消息</span><br><span class="line">$ws-&gt;emit(&quot;this is server&quot;, $ws-&gt;getSender());</span><br><span class="line">//给指定一个fd发消息</span><br><span class="line">$ws-&gt;to($to)-&gt;emit(&quot;messagecallback&quot;,$data);</span><br><span class="line">//给指定多个人发消息</span><br><span class="line">$ws-&gt;to([1,2,3])-&gt;emit(&quot;messagecallback&quot;,$data);</span><br><span class="line">//发送给所有的(不包含自己)</span><br><span class="line">$ws-&gt;broadcast()-&gt;emit(&quot;messagecallback&quot;,$data);</span><br><span class="line">//模拟formfd 给tofd 发送消息</span><br><span class="line">$ws-&gt;setSender($formfd)-&gt;to($tofd)-&gt;emit(&quot;messagecallback&quot;,$data);</span><br></pre></td></tr></table></figure><blockquote><p>注意：在多个实时通讯场景下使用 <code>emit</code></p><p>第一个参数传入 传入 事件名称callback 例如 <code>messagecallback</code></p></blockquote><p>如果你发现你think-swoole中有些没有swoole中的方法可以这么干</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$sw = app(&#x27;swoole.server&#x27;);</span><br><span class="line">$sw = app(&quot;think\swoole\Manager&quot;)-&gt;getServer();</span><br><span class="line">//以上二选一</span><br><span class="line"></span><br><span class="line">$es = $sw-&gt;isEstablished($fd); //检查连接是否为有效的WebSocket客户端连接</span><br><span class="line">var_dump($es);</span><br></pre></td></tr></table></figure><h2 id="聊天室room实现"><a href="#聊天室room实现" class="headerlink" title="聊天室room实现"></a>聊天室room实现</h2><p>前端文件参考 <code>html\room.html</code> 或 <code>html\room-socket-io.html</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwRoomJoin</span><br><span class="line">php think make:listener SwRoomLeave</span><br><span class="line">php think make:listener SwRoomMessage</span><br></pre></td></tr></table></figure><p>事件绑定</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 加入房间</span><br><span class="line">&#x27;swoole.websocket.RoomJoin&#x27; =&gt; [</span><br><span class="line">	\app\listener\SwRoomJoin::class</span><br><span class="line">],</span><br><span class="line">// 离开房间</span><br><span class="line">&#x27;swoole.websocket.Roomleave&#x27; =&gt; [</span><br><span class="line">	\app\listener\SwRoomLeave::class</span><br><span class="line">],</span><br><span class="line">// 在房间发消息</span><br><span class="line">&#x27;swoole.websocket.RoomMessage&#x27; =&gt; [</span><br><span class="line">	\app\listener\SwRoomMessage::class</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>加入房间逻辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public function handle($event, \think\swoole\websocket $ws, \think\swoole\websocket\room $room)</span><br><span class="line">&#123;</span><br><span class="line">    $fd = $ws-&gt;getSender();</span><br><span class="line">    //客户端假如定的room</span><br><span class="line">    $roomid = $event[&#x27;room&#x27;];</span><br><span class="line">    //获取指定房间下有哪些客户端</span><br><span class="line">    $roomfds = $room-&gt;getClients($roomid);</span><br><span class="line">    // 判断这个房间有没有自己 如果有自己就不需要再次发送通知</span><br><span class="line">    if (in_array($fd, $roomfds)) &#123;</span><br><span class="line">        $ws-&gt;to($roomfds)-&gt;emit(&quot;roomjoincallback&quot;, &quot;房间&#123;$roomid&#125;已加入&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //加入房间</span><br><span class="line">    $ws-&gt;join($roomid);</span><br><span class="line">    $ws-&gt;to($roomfds)-&gt;emit(&quot;roomjoincallback&quot;, &quot;&#123;$fd&#125;加入房间&#123;$roomid&#125;成功&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>离开房间逻辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public function handle($event, \think\swoole\websocket $ws, \think\swoole\websocket\Room $room)</span><br><span class="line">&#123;</span><br><span class="line">    $roomid = $event[&#x27;room&#x27;];</span><br><span class="line">    $fd = $ws-&gt;getSender();</span><br><span class="line">    $roomfds = $room-&gt;getClients($roomid);</span><br><span class="line">    if (!in_array($fd, $roomfds)) &#123;</span><br><span class="line">        $ws-&gt;emit(&quot;roomleavecallback&quot;, &quot;&#123;$fd&#125;不在&#123;$roomid&#125;房间内，怎么离开~&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //离开房间</span><br><span class="line">    $ws-&gt;leave($roomid);</span><br><span class="line">    //获取当前客户端加入了哪些客户端</span><br><span class="line">    $rooms = $room-&gt;getRooms($fd);</span><br><span class="line">    $ws-&gt;to($roomfds)-&gt;emit(&quot;roomleavecallback&quot;, &quot;&#123;$fd&#125;已离开了~~&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在房间发布聊天逻辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public function handle($event, \think\swoole\websocket $ws, \think\swoole\websocket\room $room)</span><br><span class="line">&#123;</span><br><span class="line">    //</span><br><span class="line">    $roomid = $event[&#x27;room&#x27;];</span><br><span class="line">    $text = $event[&#x27;text&#x27;];</span><br><span class="line">    $fd = $ws-&gt;getSender();</span><br><span class="line">    $roomfds = $room-&gt;getClients($roomid);</span><br><span class="line">    if (!in_array($fd, $roomfds)) &#123;</span><br><span class="line">        $ws-&gt;emit(&quot;roommessagecallback&quot;, &quot;&#123;$fd&#125;不在&#123;$roomid&#125;房间内，无法进入发布聊天~&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    $ws-&gt;to($roomfds)-&gt;emit(&quot;roommessagecallback&quot;,  $text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="事件订阅"><a href="#事件订阅" class="headerlink" title="事件订阅"></a>事件订阅</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwSubscribe</span><br></pre></td></tr></table></figure><p>app\listener\SwSubscribe.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">declare (strict_types = 1);</span><br><span class="line"></span><br><span class="line">namespace app\listener;</span><br><span class="line"></span><br><span class="line">class SwSubscribe</span><br><span class="line">&#123;</span><br><span class="line">    protected $ws = null;</span><br><span class="line"></span><br><span class="line">    // public function __construct()</span><br><span class="line">    // &#123;</span><br><span class="line">    //     $this-&gt;ws = app(&#x27;think\swoole\Websocket&#x27;);</span><br><span class="line">    // &#125;</span><br><span class="line"></span><br><span class="line">    public function __construct(\think\Container $c)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;ws = $c-&gt;make(\think\swoole\Websocket::class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public function onConnect()</span><br><span class="line">    &#123;</span><br><span class="line">        $fd = $this-&gt;ws-&gt;getSender();</span><br><span class="line">        echo &quot;server: handshake success with fd&#123;$fd&#125;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function onClose()</span><br><span class="line">    &#123;</span><br><span class="line">        $fd = $this-&gt;ws-&gt;getSender();</span><br><span class="line">        echo &quot;client &#123;$fd&#125; closed\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function onMessage($event)</span><br><span class="line">    &#123;</span><br><span class="line">        $fd = $this-&gt;ws-&gt;getSender();</span><br><span class="line">        var_dump($event);</span><br><span class="line">        echo &quot;server: handshake success with fd&#123;$fd&#125;\n&quot;;</span><br><span class="line">        $this-&gt;ws-&gt;emit(&quot;this is server&quot;, $fd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>有点类似 将原生的swoole代码改成面向对象代码，生效方法 <code>config\swoole.php</code>中在<code>subscribe</code> 加入<code>\app\listener\SwSubscribe::class</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;subscribe&#x27;     =&gt; [</span><br><span class="line">	\app\listener\SwSubscribe::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>在<code>app\event.php</code>文件中的 <code>swoole.websocket.Connect</code> 相当于 <code>app\listener\SwSubscribe.php</code>文件中的<code>onConnect</code>函数。如果同时存在的存在的话，就会向客户端发送2次以上的消息</p></blockquote><h2 id="Task任务投递"><a href="#Task任务投递" class="headerlink" title="Task任务投递"></a>Task任务投递</h2><p><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/start/start_task">https://wiki.swoole.com/#/start/start_task</a></p><p>生成事件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwSendEmailTask</span><br></pre></td></tr></table></figure><p>编写发送邮件方法<code>app\listener\SwSendEmailTask.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public function handle($event)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump($event);</span><br><span class="line">    //</span><br><span class="line">    echo &quot;开发发送邮件&quot;.time();</span><br><span class="line">    sleep(3);</span><br><span class="line">    echo &quot;结束发送邮件&quot;.time();</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>注册事件<code>app\event.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;swoole.task&#x27;=&gt;[</span><br><span class="line">	\app\listener\SwSendEmailTask::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>在控制器中投递任务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public function doRegister()</span><br><span class="line">&#123;</span><br><span class="line">    $server = app(&#x27;swoole.server&#x27;);</span><br><span class="line">    $server-&gt;task(\app\listener\SwSendEmailTask::class);</span><br><span class="line">    return &quot;注册成功&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function doRegister(\think\swoole\Manager $manager)</span><br><span class="line">&#123;</span><br><span class="line">    $server = $manager-&gt;getServer();</span><br><span class="line">    $server-&gt;task(\app\listener\SwSendEmailTask::class);</span><br><span class="line">    return &quot;注册成功&quot;;</span><br><span class="line">&#125;</span><br><span class="line">public function doRegister(\Swoole\Server $server)</span><br><span class="line">&#123;</span><br><span class="line">    $server-&gt;task(\app\listener\SwSendEmailTask::class);</span><br><span class="line">    return &quot;注册成功&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>三种获取<code>\Swoole\Server</code>,任意选其一</p></blockquote><p>在swoole中还有一个事件叫<code>finish</code>，它的作用就是把异步任务的结果返回，在think-swool是这么处理的</p><p>定义一个发送邮件异步任务处理结果的事件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:listener SwSendEmailFinish</span><br></pre></td></tr></table></figure><p>注册事件<code>app\event.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;swoole.finish&#x27;=&gt;[</span><br><span class="line">	\app\listener\SwSendEmailFinish::class</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>在task任务中调用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public function handle($event)</span><br><span class="line">&#123;</span><br><span class="line">    var_dump($event);</span><br><span class="line">    //</span><br><span class="line">    echo &quot;开发发送邮件&quot;.time();</span><br><span class="line">    sleep(3);</span><br><span class="line">    echo &quot;结束发送邮件&quot;.time();</span><br><span class="line">    $event-&gt;finish(\app\listener\SwSendEmailFinish::class);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h2 id="高性能共享内存-Table"><a href="#高性能共享内存-Table" class="headerlink" title="高性能共享内存 Table"></a>高性能共享内存 Table</h2><p><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/memory/table">https://wiki.swoole.com/#/memory/table</a></p><p>先定结构在进行操作数据（原生swoole操作）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$table = new Swoole\Table(1024);</span><br><span class="line">//创建表</span><br><span class="line">$table-&gt;column(&quot;id&quot;, Swoole\Table::TYPE_INT);</span><br><span class="line">$table-&gt;column(&quot;name&quot;, Swoole\Table::TYPE_STRING);</span><br><span class="line">$table-&gt;column(&quot;money&quot;, Swoole\Table::TYPE_FLOAT);</span><br><span class="line">$table-&gt;create();</span><br><span class="line"></span><br><span class="line">//添加数据</span><br><span class="line">$table-&gt;set(&quot;zq&quot;, [</span><br><span class="line">    &#x27;id&#x27; =&gt; 1,</span><br><span class="line">    &#x27;name&#x27; =&gt; &quot;zhiqiang&quot;,</span><br><span class="line">    &#x27;money&#x27; =&gt; 100,</span><br><span class="line">]);</span><br><span class="line">//获取一行数据</span><br><span class="line">$table-&gt;get(&quot;zq&quot;);</span><br><span class="line">// 修改数据</span><br><span class="line">// 字段递增</span><br><span class="line">$table-&gt;incr(&quot;zq&quot;,&quot;money&quot;,2);</span><br><span class="line">//递减</span><br><span class="line">$table-&gt;decr(&quot;zq&quot;,&quot;money&quot;,2);</span><br><span class="line">// 返回 table 中存在的条目数。</span><br><span class="line">$table-&gt;count();</span><br><span class="line">//遍历table中的数据</span><br><span class="line">foreach($table as $item)&#123;</span><br><span class="line">    var_dump($item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>think-swoole中的操作</p><p>先对table表结构进行初始化<code>config\swoole.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x27;tables&#x27;     =&gt; [</span><br><span class="line">    &#x27;user&#x27;=&gt;[</span><br><span class="line">        &#x27;size&#x27;=&gt;1024,</span><br><span class="line">        &#x27;columns&#x27;=&gt;[</span><br><span class="line">            [</span><br><span class="line">                &#x27;name&#x27;=&gt;&#x27;id&#x27;,</span><br><span class="line">                &#x27;type&#x27;=&gt;\Swoole\Table::TYPE_INT</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                &#x27;name&#x27;=&gt;&#x27;name&#x27;,</span><br><span class="line">                &#x27;type&#x27;=&gt;\Swoole\Table::TYPE_STRING,</span><br><span class="line">                &#x27;size&#x27;=&gt;32</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                &#x27;name&#x27;=&gt;&#x27;money&#x27;,</span><br><span class="line">                &#x27;type&#x27;=&gt;\Swoole\Table::TYPE_FLOAT</span><br><span class="line">            ],</span><br><span class="line"></span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>操作数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$table =  app(&#x27;swoole.table.user&#x27;);</span><br><span class="line">$table-&gt;set(&quot;zq&quot;, [</span><br><span class="line">    &#x27;id&#x27; =&gt; 1,</span><br><span class="line">    &#x27;name&#x27; =&gt; &quot;zhiqiang&quot;,</span><br><span class="line">    &#x27;money&#x27; =&gt; 100</span><br><span class="line">]);</span><br><span class="line">//获取一行数据</span><br><span class="line">$table-&gt;get(&quot;zq&quot;);</span><br><span class="line">// 修改数据</span><br><span class="line">// 字段递增</span><br><span class="line">$table-&gt;incr(&quot;zq&quot;, &quot;money&quot;, 2);</span><br><span class="line">//递减</span><br><span class="line">$table-&gt;decr(&quot;zq&quot;, &quot;money&quot;, 2);</span><br><span class="line">// 返回 table 中存在的条目数。</span><br><span class="line">$table-&gt;count();</span><br><span class="line">//遍历table中的数据</span><br><span class="line">foreach ($table as $item) &#123;</span><br><span class="line">var_dump($item);</span><br><span class="line">&#125;</span><br><span class="line">// 检查 table 中是否存在某一个 key。</span><br><span class="line">$table-&gt;exist(&#x27;zq&#x27;);</span><br><span class="line">//获取实际占用内存尺寸,单位字节</span><br><span class="line">$table-&gt;momorySize();</span><br></pre></td></tr></table></figure><h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>RPC(Remote Procedure Call)：远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的思想。</p><p>详细介绍：<a target="_blank" rel="noopener" href="https://developer.51cto.com/art/201906/597963.htm">https://developer.51cto.com/art/201906/597963.htm</a></p><ul><li>解决分布式系统中，服务之间的调用问题。</li><li>远程调用时，要能够像本地调用一样方便，让调用者感知不到远程调用的逻辑。</li><li>节点角色说明：</li><li>Server: 暴露服务的服务提供方</li><li>Client: 调用远程服务的服务消费方</li><li>Registry: 服务注册与发现的注册中心</li></ul><p>think-swoole实现RPC功能</p><h3 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h3><h4 id="接口定义app-rpc-interfaces-UserInterface-php"><a href="#接口定义app-rpc-interfaces-UserInterface-php" class="headerlink" title="接口定义app/rpc/interfaces/UserInterface.php"></a>接口定义<code>app/rpc/interfaces/UserInterface.php</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\rpc\interfaces;</span><br><span class="line">interface UserInterface</span><br><span class="line">&#123;</span><br><span class="line">    public function create();</span><br><span class="line">    public function find(int $id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现接口app-rpc-services-UserService-php"><a href="#实现接口app-rpc-services-UserService-php" class="headerlink" title="实现接口app/rpc/services/UserService.php"></a>实现接口<code>app/rpc/services/UserService.php</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\rpc\services;</span><br><span class="line">use app\rpc\interfaces\UserInterface;</span><br><span class="line">class UserService implements UserInterface</span><br><span class="line">&#123;</span><br><span class="line">    public function create()</span><br><span class="line">    &#123;</span><br><span class="line">        // TODO: Implement create() method.</span><br><span class="line">        return &quot;service create success&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function find(int $id)</span><br><span class="line">    &#123;</span><br><span class="line">        // TODO: Implement find() method.</span><br><span class="line">        return $id. &quot;查询数据遍历&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="注册rpc服务config-swoole-php"><a href="#注册rpc服务config-swoole-php" class="headerlink" title="注册rpc服务config/swoole.php"></a>注册rpc服务<code>config/swoole.php</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x27;rpc&#x27;        =&gt; [</span><br><span class="line">    &#x27;server&#x27; =&gt; [</span><br><span class="line">    	//开启rpc服务</span><br><span class="line">        &#x27;enable&#x27;   =&gt; true,</span><br><span class="line">        //rpc端口</span><br><span class="line">        &#x27;port&#x27;     =&gt; 9000,</span><br><span class="line">        &#x27;services&#x27; =&gt; [</span><br><span class="line">        	//注册服务</span><br><span class="line">            \app\rpc\services\UserService::class</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">    // 如果填写也是可以调用其他服务端</span><br><span class="line">    &#x27;client&#x27; =&gt; [</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>启动服务端</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think swoole start /  php think swoole:rpc</span><br></pre></td></tr></table></figure><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x27;rpc&#x27;        =&gt; [</span><br><span class="line">    &#x27;server&#x27; =&gt; [</span><br><span class="line">    ],</span><br><span class="line">    &#x27;client&#x27; =&gt; [</span><br><span class="line">        &#x27;tp6&#x27;=&gt;[</span><br><span class="line">        	//服务端的ip地址</span><br><span class="line">            &#x27;host&#x27;=&gt;&#x27;127.0.0.1&#x27;,</span><br><span class="line">            //服务端对应的端口</span><br><span class="line">            &#x27;port&#x27;=&gt;&#x27;9000&#x27;</span><br><span class="line">        ]</span><br><span class="line">        // 更多服务端</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>运行<code>php think rpc:interface</code>生成RPC接口文件<code>app\rpc.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * This file is auto-generated.</span><br><span class="line"> */</span><br><span class="line">declare(strict_types=1);</span><br><span class="line">namespace rpc\contract\tp6;</span><br><span class="line">interface UserInterface</span><br><span class="line">&#123;</span><br><span class="line">	public function create();</span><br><span class="line">	public function find(int $id);</span><br><span class="line">&#125;</span><br><span class="line">return [&#x27;tp6&#x27; =&gt; [&#x27;rpc\contract\tp6\UserInterface&#x27;]];</span><br></pre></td></tr></table></figure><p>在控制器调用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    public function index(\rpc\contract\tp6\UserInterface $user)</span><br><span class="line">    &#123;</span><br><span class="line">        //</span><br><span class="line">        $user-&gt;find(1);</span><br><span class="line">//        $user-&gt;create();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h2><p>在think-swoole 2.0版本的时候还是支持自定义定时任务配置,详细参考<a target="_blank" rel="noopener" href="https://github.com/top-think/think-swoole/tree/2.0">https://github.com/top-think/think-swoole/tree/2.0</a></p><p>在3.0就不支持了，在这里介绍一个通用的命令行启动定时任务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php think make:command SwooleTimer</span><br></pre></td></tr></table></figure><p>加载命令行<code>config/console.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x27;commands&#x27; =&gt; [</span><br><span class="line">	&#x27;swooletimer&#x27;=&gt;app\command\SwooleTimer::class</span><br><span class="line">	...........</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>书写命令脚本<code>app/command/SwooleTimer.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">declare (strict_types = 1);</span><br><span class="line"></span><br><span class="line">namespace app\command;</span><br><span class="line"></span><br><span class="line">use think\console\Command;</span><br><span class="line">use think\console\input\Argument;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class SwooleTimer extends Command</span><br><span class="line">&#123;</span><br><span class="line">    protected function configure()</span><br><span class="line">    &#123;</span><br><span class="line">        // 指令配置</span><br><span class="line">        $this-&gt;setName(&#x27;app\command\swooletimer&#x27;)</span><br><span class="line">            -&gt;addArgument(&#x27;action&#x27;, Argument::OPTIONAL, &quot;start | stop&quot;, &#x27;start&#x27;)</span><br><span class="line">            -&gt;setDescription(&#x27;Swoole Timer for ThinkPHP&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public function handle()</span><br><span class="line">    &#123;</span><br><span class="line">        $action = $this-&gt;input-&gt;getArgument(&#x27;action&#x27;);</span><br><span class="line">        if (in_array($action, [&#x27;start&#x27;,&#x27;stopall&#x27;])) &#123;</span><br><span class="line">            $this-&gt;app-&gt;invokeMethod([$this, $action], [], true);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;output-&gt;writeln(&quot;&lt;error&gt;Invalid argument action:&#123;$action&#125;, Expected start&lt;/error&gt;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 启动定时任务 主要任务计划在这里书写</span><br><span class="line">     */</span><br><span class="line">    protected function start()</span><br><span class="line">    &#123;</span><br><span class="line">        // https://wiki.swoole.com/#/timer</span><br><span class="line">        $timer_id=swoole_timer_tick(2000,function ()&#123;</span><br><span class="line">            echo &quot;2s循环执行需要做的事情&quot;.time().&quot;\n&quot;;</span><br><span class="line">        &#125;);</span><br><span class="line">        $this-&gt;output-&gt;writeln(&quot;Swoole Timer_id:&#123;$timer_id&#125; &quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 清除所有的定时任务</span><br><span class="line">     */</span><br><span class="line">    protected  function stop()&#123;</span><br><span class="line">        swoole_timer_clear_all();</span><br><span class="line">        $this-&gt;output-&gt;writeln(&quot;Swoole Timer  clear all ok&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p></div><hr class="layui-border-orange"></div></div><style>.layui-content table{border-collapse:collapse;border-spacing:0;margin:10px 0;display:table}.layui-content table td,table th{padding:10px;border:1px solid #ddd;color:#333;vertical-align:middle;word-break:normal!important}.layui-content table .gutter{display:none}.layui-content figure.highlight{margin:15px 0;background:#e3e3e3;padding:0;line-height:24px;overflow-x:auto}.layui-content figure.highlight table td{border:0}.layui-content blockquote{margin:15px 0;background:#e3e3e3;border-left:3px solid #5fb878;padding:10px 0 0 20px}.layui-content ol li{margin-bottom:10px;list-style:decimal;margin-left:10px}.layui-content ul li{margin-bottom:10px;list-style:inside;margin-left:10px}.layui-content code{background-color:#e3e3e3}.layui-content a{text-decoration:underline;color:#1e9fff}body img{max-width:100%}</style></div></div></div><div class="footer"><p><span>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> </span><span>| </span><span>Theme - <a href="https://github.com/zzqqw/hexo-theme-xianxin" target="_blank">xianxin</a></span></p><p><span>&copy; 2024</span> <span>MIT license</span></p><script async src="https://www.googletagmanager.com/gtag/js?id=G-TBH6G20B8Y"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-TBH6G20B8Y")</script></div></body></html>